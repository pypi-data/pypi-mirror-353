var y=`<div class="widget timeseries-widget">
  <div class="header">
    <span class="title" id="title"></span>
    <div class="legend" id="legend"></div>
  </div>
  <div class="graph" id="canvas-holder">
    <canvas id="canvas"></canvas>
  </div>
  <div class="controls">
    <div class="left">
      <div>
        <button id="btnAdd"></button>
        <button id="btnDelete"></button>
      </div>
      <div class="dropdown">
        <button class="dropbtn" id="btnToggleTagsList">
          Edit Tags
        </button>
        <div id="tagsList" class="dropdown-content"></div>
      </div>
    </div>
    <div class="right">
      <!-- <button id="btnZoomIn"></button> -->
      <!-- <button id="btnZoomOut"></button> -->
    </div>
  </div>
</div>
`;var v=class{constructor({model:e,el:n}){this.tagInputElements=[];this.lastAnimationFrameTimestamp=null;this.animationFrameRequestId=null;this.values=[];this.annotations=[];this.tags=[];this.window_size_in_s=5;this.selectedAnnIndex=null;this.selectedResizingHandle=null;this.selectedMoveHandle=null;this.model=e,this.el=n,n.innerHTML=y,this.canvas=n.querySelector("#canvas"),this.canvas.addEventListener("mousedown",this.canvasMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.canvasMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.canvasMouseUp.bind(this)),this.btnAdd=n.querySelector("#btnAdd"),this.btnAdd.innerHTML=this.model.get("icons").add,this.btnAdd.addEventListener("click",this.btnAddClicked.bind(this)),this.btnDelete=n.querySelector("#btnDelete"),this.btnDelete.innerHTML=this.model.get("icons").delete,this.btnDelete.addEventListener("click",this.btnDeleteClicked.bind(this)),this.btnToggleTagsList=n.querySelector("#btnToggleTagsList"),this.btnToggleTagsList.addEventListener("click",this.toggleTagsList.bind(this)),this.tagsList=n.querySelector("#tagsList"),this.currentTime=this.model.get("sync_time");let t=this.model.get("times"),s=t.buffer||t;this.times=new Float64Array(s);let a=this.model.get("values"),i=a.buffer||a,d=new Float64Array(i),r=this.times.length,o=d.length;this.numChannels=o/r;for(let l=0;l<this.numChannels;l++)this.values.push(d.slice(l*r,l*r+r));this.annotations=this.model.get("annotations"),this.yRange=this.model.get("y_range"),this.tags=this.model.get("tags"),this.populateTagsList(),this.addLegend(),this.addTitle()}populateTagsList(){for(let e of this.tags){let n=document.createElement("label"),t=document.createElement("input"),s=document.createTextNode(e);t.type="checkbox",t.value=e,t.addEventListener("change",this.tagToggled.bind(this)),n.appendChild(t),n.appendChild(s),this.tagInputElements.push(t),this.tagsList.appendChild(n)}}tagToggled(e){if(this.selectedAnnIndex==null)return;let n=e.target,t=this.annotations[this.selectedAnnIndex];n.checked?t.tags.push(n.value):t.tags=t.tags.filter(s=>s!==n.value),this.syncAnnotations()}canvasMouseDown(e){this.checkForHandleSelection(e.offsetX)||(this.checkForAnnSelection(e.offsetX)?(this.updateTagCheckboxes(),this.btnToggleTagsList.classList.add("show")):(this.btnToggleTagsList.classList.remove("show"),this.tagsList.classList.remove("show")))}updateTagCheckboxes(){if(this.selectedAnnIndex==null)return;let e=this.annotations[this.selectedAnnIndex].tags;for(let n of this.tagInputElements)n.checked=e.includes(n.value)}canvasMouseMove(e){this.selectedResizingHandle!=null?this.resizeAnnotation(e.offsetX):this.selectedMoveHandle!=null&&this.moveAnnotation(e.offsetX)}resizeAnnotation(e){if(this.selectedResizingHandle==null)return;let n=this.canvas.width,t=this.currentTime+this.window_size_in_s*(e-n/2)/n;this.selectedResizingHandle.side=="left"?this.annotations[this.selectedResizingHandle.annIndex].start=t:this.annotations[this.selectedResizingHandle.annIndex].end=t}moveAnnotation(e){if(this.selectedMoveHandle==null)return;let n=this.canvas.width,t=this.window_size_in_s*(e-this.selectedMoveHandle.grabX)/n;this.annotations[this.selectedMoveHandle.annIndex].start=this.selectedMoveHandle.annStart+t,this.annotations[this.selectedMoveHandle.annIndex].end=this.selectedMoveHandle.annEnd+t}canvasMouseUp(){this.selectedResizingHandle=null,this.selectedMoveHandle=null,this.syncAnnotations()}btnAddClicked(){this.annotations.push({start:this.currentTime,end:this.currentTime+.5,tags:[]}),this.selectedAnnIndex=this.annotations.length-1,this.syncAnnotations()}btnDeleteClicked(){this.selectedAnnIndex!=null&&(this.annotations.splice(this.selectedAnnIndex,1),this.selectedAnnIndex=null,this.syncAnnotations())}toggleTagsList(){this.tagsList.classList.toggle("show")}syncAnnotations(){this.model.set("annotations",[]),this.model.set("annotations",[...this.annotations]),this.model.save_changes()}checkForAnnSelection(e){let n=this.currentTime-this.window_size_in_s/2,t=this.currentTime+this.window_size_in_s/2,s=this.getAnnotationsToDraw(n,t);this.selectedAnnIndex=null;for(let a=0;a<s.length;a++){let i=s[a];if(!(i.start>e||i.start+i.width<e))return this.selectedAnnIndex=i.index,!0}return!1}checkForHandleSelection(e){let n=this.currentTime-this.window_size_in_s/2,t=this.currentTime+this.window_size_in_s/2,s=this.getAnnotationsToDraw(n,t);this.selectedResizingHandle=null,this.selectedMoveHandle=null;for(let a=0;a<s.length;a++){let i=s[a];if(Math.abs(e-i.start)<6)return this.selectedResizingHandle={annIndex:i.index,side:"left"},!0;if(Math.abs(e-i.start-i.width)<6)return this.selectedResizingHandle={annIndex:i.index,side:"right"},!0;e>i.start&&e<i.start+i.width&&(this.selectedMoveHandle={annIndex:i.index,grabX:e,annStart:this.annotations[i.index].start,annEnd:this.annotations[i.index].end})}return!1}addLegend(){let e=this.el.querySelector("#legend");for(let n of this.model.get("channel_names")){let t=this.model.get("channel_names").findIndex(a=>a==n),s=document.createElement("span");s.innerHTML=n,s.style.setProperty("--line-color",this.getPlotColor(t)),e.append(s)}}addTitle(){let e=this.el.querySelector("#title");e.innerHTML=this.model.get("title")}getPlotColor(e){let n=["#F44336","#4CAF50","#2196F3","#FFEB3B","#795548","#673AB7"],t=e%n.length;return n[t]}getTagColor(e){let n=["#F44336","#3F51B5","#00BCD4","#9C27B0","#E91E63","#CDDC39","#795548","#FFEB3B","#607D8B","#2196F3"],t=e%n.length;return n[t]}step(e){if(!this.lastAnimationFrameTimestamp){let t=this.el.querySelector("#canvas-holder");this.canvas.width=t.clientWidth,this.canvas.height=t.clientHeight,this.canvas.style.width="100%",this.canvas.style.height="100%",this.lastAnimationFrameTimestamp=e}let n=e-this.lastAnimationFrameTimestamp;if(this.lastAnimationFrameTimestamp=e,this.model.get("is_running")){let t=this.times[this.times.length-1];this.currentTime=Math.min(this.currentTime+n/1e3,t)}this.clearFrame(),this.draw(),this.animationFrameRequestId=requestAnimationFrame(this.step)}draw(){let e=this.currentTime-this.window_size_in_s/2,n=this.currentTime+this.window_size_in_s/2,t=this.times.findIndex(l=>l>=e),s=this.times.findIndex(l=>l>n),a=s!=-1?Math.max(s-1,0):this.times.length-1,i=this.times[t]-this.currentTime,d=this.times[a]-this.currentTime,r=Math.max(i/this.window_size_in_s+.5,0),o=d/this.window_size_in_s+.5;this.drawAnnotations(e,n);for(let l=0;l<this.numChannels;l++)this.drawPlot(l,t,a,r,o)}getRange(e,n){let t=this.yRange.min,s=this.yRange.max;if(t!=null&&s!=null)return{min:t,max:s};let a=[],i=[];for(let d=0;d<this.numChannels;d++)t==null&&a.push(Math.min(...this.values[d].slice(e,n+1))),s==null&&i.push(Math.max(...this.values[d].slice(e,n+1)));return{min:t||Math.min(...a),max:s||Math.max(...i)}}drawPlot(e,n,t,s,a){if(isNaN(n)||isNaN(t))return;let i=this.canvas.getContext("2d"),d=this.canvas.width,r=this.canvas.height;if(!i){console.error("Failed to get 2D context");return}i.strokeStyle=this.getPlotColor(e),i.lineWidth=2,i.beginPath();let o=t-n,l=d,c=s*l,h=a*l-c,m=r,{min:u,max:A}=this.getRange(n,t),w=A-u,p=this.values[e];i.moveTo(c,r-m*(p[n]-u)/w);let T=d,f=o>T?Math.floor(o/T):1;for(let b=Math.max(0,n-f);b<Math.min(p.length,t+2*f);b+=f){let _=(b-n)/o*h+c,M=r-m*(p[b]-u)/w;i.lineTo(_,M)}i.stroke()}getAnnotationsToDraw(e,n){let t=[],s=this.canvas.width,a=0,i=1,d=s,r=d*a,l=d*i-r,c=n-e;for(let g=0;g<this.annotations.length;g++){let h=this.annotations[g];if(h.start>=e&&h.start<=n||h.end>=e&&h.end<=n||h.start<=e&&h.end>=n){let m=l*(Math.max(h.start,e)-e)/c,u=l*(Math.min(h.end,n)-e)/c;t.push({start:r+m,width:u-m,color:"#607D8B",index:g})}}return t}drawAnnotations(e,n){let t=this.canvas.getContext("2d");if(!t){console.error("Failed to get 2D context");return}let s=this.canvas.height,a=1,i=5,d=this.getAnnotationsToDraw(e,n);for(let r=0;r<d.length;r++){let o=d[r],l=o.color,c="22";this.selectedAnnIndex!=null&&(l=o.index==this.selectedAnnIndex?o.color:"#78909C",c=o.index==this.selectedAnnIndex?"44":"22"),t.fillStyle=l+c,t.fillRect(o.start,0,o.width,s),t.fillStyle=l,t.fillRect(o.start+a,a,o.width-2*a,i-a),this.selectedAnnIndex==o.index&&(t.lineCap="round",t.strokeStyle=l,t.lineWidth=4,t.beginPath(),t.moveTo(o.start-4,s/2-12),t.lineTo(o.start-4,s/2+12),t.stroke(),t.beginPath(),t.moveTo(o.start+4,s/2-12),t.lineTo(o.start+4,s/2+12),t.stroke(),t.beginPath(),t.moveTo(o.start+o.width-4,s/2-12),t.lineTo(o.start+o.width-4,s/2+12),t.stroke(),t.beginPath(),t.moveTo(o.start+o.width+4,s/2-12),t.lineTo(o.start+o.width+4,s/2+12),t.stroke())}}clearFrame(){let e=this.canvas.getContext("2d"),n=this.canvas.width,t=this.canvas.height;if(!e){console.error("Failed to get 2D context");return}e.clearRect(0,0,n,t),e.strokeStyle="#607d8b",e.beginPath(),e.moveTo(0,t/2),e.lineTo(n,t/2),e.stroke(),e.beginPath(),e.moveTo(n/2,0),e.lineTo(n/2,t),e.stroke()}syncTimeChanged(){this.currentTime=this.model.get("sync_time")}isRunningChanged(){}render(){this.model.on("change:sync_time",this.syncTimeChanged.bind(this)),this.model.on("change:is_running",this.isRunningChanged.bind(this)),this.step=this.step.bind(this),this.animationFrameRequestId=requestAnimationFrame(this.step)}destroy(){cancelAnimationFrame(this.animationFrameRequestId)}},D={render(x){let e=new v(x);return e.render(),()=>e.destroy()}};export{D as default};
