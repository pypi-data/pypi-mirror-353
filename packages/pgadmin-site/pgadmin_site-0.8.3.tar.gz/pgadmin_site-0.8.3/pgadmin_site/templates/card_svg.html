<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карточки - SVG</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { padding-top: 20px; background: {{ bkg|default('#FFFFFF') }}; }
        .svg-card-list { display: flex; flex-direction: column; align-items: flex-start; }
        .svg-card { margin-bottom: 30px; width: fit-content; min-width: 350px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        .card, .navbar, .footer { background: {{ sec|default('#F4E8D3') }}; border-radius: 8px; }
        .btn-accent, .active, .highlight { background: {{ acc|default('#67BA80') }} !important; color: #fff !important; border: none; }
        .btn-accent:hover { background: #4fa96a; }
        h1, h2, h3, h4, h5 { color: {{ acc|default('#67BA80') }}; }
        .alert { border-radius: 8px; }
    </style>
</head>
<body style="background: {{ bkg|default('#FFFFFF') }};">
{% if foto_enabled %}
{% include 'foto_block.html' %}
{% endif %}
<div class="container">
    <header class="pb-3 mb-4 border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <a href="{{ url_for('index') }}" class="text-dark text-decoration-none">
                    <span class="fs-4"></span>
                </a>
                <span class="ms-2 fs-6 text-muted">Карточки</span>
            </div>
            <div>
                <a href="{{ url_for('view_table', table_name=card_template[0].get('db_table', '') or card_template[1].get('db_table', '') or card_template[2].get('db_table', '') ) }}" class="btn btn-primary me-2">К таблице</a>
                <a href="{{ url_for('add_row', table_name=card_template[0].get('db_table', '') or card_template[1].get('db_table', '') or card_template[2].get('db_table', '') ) }}" class="btn btn-success me-2">Добавить</a>
                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteCardModal">Удалить</button>
            </div>
        </div>
    </header>
    <!-- Модальное окно для удаления карточки -->
    <div class="modal fade" id="deleteCardModal" tabindex="-1" aria-labelledby="deleteCardModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteCardModalLabel">Удалить карточку</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form method="POST" action="{{ url_for('delete_card', card=card_name) }}">
          <div class="modal-body">
            <label for="cardKey" class="form-label">Выберите карточку для удаления:</label>
            <select class="form-select" id="cardKey" name="card_key" required>
              {% set main_col = data[0].keys()|list|first %}
              {% for row in data %}
                <option value="{{ row[main_col] }}">{{ row[main_col] }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Будут удалены все связанные данные этой карточки.</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-danger">Удалить</button>
          </div>
          </form>
        </div>
      </div>
    </div>
    <main>
        <div class="svg-card-list">
        {% set max_x = card_template | map(attribute='x2') | max %}
        {% set max_y = card_template | map(attribute='y2') | max %}
        {% for row in data %}
            {% set row_idx = loop.index0 %}
            <div class="card svg-card">
                <div class="card-body">
                    <svg width="{{ max_x + 20 }}" height="{{ max_y + 20 }}" viewBox="0 0 {{ max_x + 20 }} {{ max_y + 20 }}">
                        {% for fig in card_template %}
                            {% if fig.type == 'Rectangle' %}
                                <rect x="{{fig.x1}}" y="{{fig.y1}}" width="{{fig.x2-fig.x1}}" height="{{fig.y2-fig.y1}}" fill="{{fig.fill}}" stroke="{{fig.outline}}" stroke-width="{{fig.width}}"/>
                            {% elif fig.type == 'Ellipse' %}
                                <ellipse cx="{{(fig.x1+fig.x2)/2}}" cy="{{(fig.y1+fig.y2)/2}}" rx="{{abs(fig.x2-fig.x1)/2}}" ry="{{abs(fig.y2-fig.y1)/2}}" fill="{{fig.fill}}" stroke="{{fig.outline}}" stroke-width="{{fig.width}}"/>
                            {% elif fig.type == 'Line' %}
                                <line x1="{{fig.x1}}" y1="{{fig.y1}}" x2="{{fig.x2}}" y2="{{fig.y2}}" stroke="{{fig.outline}}" stroke-width="{{fig.width}}"/>
                            {% elif fig.type == 'Text' %}
                                <text x="{{(fig.x1+fig.x2)/2}}" y="{{(fig.y1+fig.y2)/2}}" fill="{{fig.text_color}}" font-size="{{fig.font_size}}"
                                    font-family="{{fig.font_family or 'Segoe UI'}}" dominant-baseline="middle" text-anchor="middle">
                                    {% if fig.formula %}
                                        {{ eval_formula(fig.formula, row) }}
                                    {% elif fig.get('db_column') and fig.get('db_table') and (fig.db_table ~ '.' ~ fig.db_column) in row %}
                                        {{ row[fig.db_table ~ '.' ~ fig.db_column] }}
                                    {% elif fig.get('db_column') and fig.db_column in row %}
                                        {{ row[fig.db_column] }}
                                    {% else %}
                                        {{ fig.text }}
                                    {% endif %}
                                </text>
                            {% elif fig.type == 'ButtonFigure' %}
                                <foreignObject x="{{fig.x1}}" y="{{fig.y1}}" width="{{fig.x2-fig.x1}}" height="{{fig.y2-fig.y1}}">
                                    <button class="btn" style="width:100%;height:100%;background:{{fig.fill}};color:#fff;border-radius:{% if fig.shape=='circle' %}50%{% elif fig.shape=='round' %}16px{% else %}4px{% endif %};font-weight:bold;white-space:normal;overflow:visible;word-break:break-word;font-size:16px;line-height:1.2;padding:4px;box-sizing:border-box;" onclick="openQueryModal({{ loop.index0 }}, {{ row_idx }})">{{ fig.text }}</button>
                                </foreignObject>
                            {% endif %}
                        {% endfor %}
                    </svg>
                </div>
            </div>
        {% endfor %}
        </div>
    </main>
</div>
<!-- Модальное окно для визуального запроса -->
<div class="modal fade" id="queryModal" tabindex="-1" aria-labelledby="queryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="queryModalLabel">Запрос по кнопке</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="queryModalBody">
        <!-- Контент будет подгружаться через JS -->
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function openQueryModal(figIdx, rowIdx) {
    var modal = new bootstrap.Modal(document.getElementById('queryModal'));
    document.getElementById('queryModalBody').innerHTML = '<div class="text-center p-5">Загрузка редактора запроса...</div>';
    modal.show();
    // AJAX-запрос к серверу
    fetch(`/button_query?fig=${figIdx}&row=${rowIdx}`)
      .then(r => r.text())
      .then(html => {
        document.getElementById('queryModalBody').innerHTML = html;
      });
}
</script>
</body>
</html> 